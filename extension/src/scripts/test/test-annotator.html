<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>DOM Annotator Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      gap: 20px;
      padding: 20px;
      margin: 0;
      background-color: #f0f2f5;
      height: 95vh;
    }

    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: white;
      overflow: hidden;
    }

    .panel h2 {
      margin: 0;
      padding: 15px;
      border-bottom: 1px solid #ccc;
      background-color: #fafafa;
      font-size: 1.1em;
    }

    .panel-content {
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }

    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      align-self: flex-start;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    label {
      font-weight: bold;
      margin-bottom: -5px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .info {
      font-size: 0.9em;
      color: #555;
    }

    .prompt-display {
      background-color: #e9ecef;
      border-left: 4px solid #007bff;
    }
  </style>
</head>

<body>

  <!-- Left Panel: The "Webpage" -->
  <div class="panel">
    <h2>Sample Webpage</h2>
    <div class="panel-content">
      <label for="htmlInput">Paste HTML to test:</label>
      <textarea id="htmlInput" placeholder="Paste the HTML content of a webpage here..."></textarea>
      <p class="info">The HTML above will be loaded into the frame below when you click the "Annotate" button.</p>
    </div>
    <iframe id="pageFrame" style="height: 50%;"></iframe>
  </div>

  <!-- Right Panel: The "AI Controller" -->
  <div class="panel">
    <h2>AI Controller</h2>
    <div class="panel-content">
      <div>
        <button id="annotateBtn">1. Annotate & Create Payload</button>
        <p class="info">Scans the webpage for interactive elements and generates a JSON list for the AI.</p>
      </div>

      <div>
        <label for="payloadOutput">Generated AI Payload:</label>
        <textarea id="payloadOutput" readonly placeholder="Click the button above..."></textarea>
      </div>

      <div>
        <label for="userInput">User's Instruction:</label>
        <input type="text" id="userInput" value="I want to log in">
      </div>

      <div>
        <label for="fullPrompt">Full Prompt for AI:</label>
        <textarea id="fullPrompt" readonly class="prompt-display"></textarea>
      </div>

      <div>
        <label for="aiResponseInput">Simulated AI Response (JSON):</label>
        <textarea id="aiResponseInput"
          placeholder='Paste the AI response here, e.g., { "id": "ai-5", "tag": "button", "text": "Log In" }'></textarea>
      </div>

      <div>
        <button id="highlightBtn" disabled>2. Find & Highlight Element</button>
        <p class="info">Uses the AI response to find and highlight the element on the webpage.</p>
      </div>
    </div>
  </div>

  <script src="test/annotator.js"></script>
  <script>
    const pageFrame = document.getElementById('pageFrame');
    const annotateBtn = document.getElementById('annotateBtn');
    const payloadOutput = document.getElementById('payloadOutput');
    const userInput = document.getElementById('userInput');
    const fullPrompt = document.getElementById('fullPrompt');
    const aiResponseInput = document.getElementById('aiResponseInput');
    const highlightBtn = document.getElementById('highlightBtn');


    // 2. Annotate and create payload
    annotateBtn.addEventListener('click', () => {
      // Parse the HTML string from the textarea into a document object in memory.
      // We don't need to render it in the iframe for this step.
      const htmlString = document.getElementById('htmlInput').value;
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, "text/html");

      // The createPayloadForAI function will add `data-ai-id` attributes to our in-memory doc.
      const payload = DOMAnnotator.createPayloadForAI(doc);
      const payloadString = JSON.stringify(payload, null, 2);
      payloadOutput.value = payloadString;

      const userInstruction = userInput.value;
      const promptText = `
Here is a simplified list of interactive elements on the page:
${payloadString}

Based on the list above, which single element best matches the user's instruction: "${userInstruction}"?

Please respond with *only* the single, complete JSON object for the matching element.`;
      fullPrompt.value = promptText.trim();
      highlightBtn.disabled = false;

      // Auto-fill the AI response for easy testing
      const matchingElement = payload.find(el => el.text.toLowerCase().includes('log in'));
      if (matchingElement) {
        aiResponseInput.value = JSON.stringify(matchingElement, null, 2);
      }
    });

    // 3. Find and highlight based on simulated AI response
    highlightBtn.addEventListener('click', () => {
      const aiResponse = aiResponseInput.value;
      // Now, we need to load the HTML into the iframe so we can see the highlight.
      // The `data-ai-id` attributes are NOT in the original HTML string, so we must
      // re-run the annotation on the iframe's document to add them before highlighting.
      const frameDoc = pageFrame.contentWindow.document;
      frameDoc.open();
      frameDoc.write(document.getElementById('htmlInput').value);
      frameDoc.close();
      DOMAnnotator.createPayloadForAI(frameDoc); // Re-annotate the live DOM
      if (aiResponse) {
        DOMAnnotator.findAndHighlight(aiResponse, frameDoc);
      } else {
        alert('Please provide a simulated AI response.');
      }
    });
  </script>
</body>

</html>